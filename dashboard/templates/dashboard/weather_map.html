{% extends "orcamet_portal/base.html" %}
{% load static %}

{% block title %}Weather Map ‚Äî OrcaMet Portal{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="" />

<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
    /* ============================================================
       WEATHER MAP ‚Äî Full-viewport Leaflet with time slider
       ============================================================ */

    .map-page {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 64px - 60px);
        min-height: 500px;
    }

    /* --- Map Controls Bar --- */
    .map-controls {
        background: var(--ocean-mid);
        border-bottom: 1px solid var(--border);
        padding: 0.6rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.75rem;
        z-index: 500;
    }

    .map-title {
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    .map-title h1 {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--white);
        margin: 0;
    }

    .map-title .map-icon { font-size: 1.3rem; }

    .map-stats {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .map-stat {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
    }

    .map-stat-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .stat-go .map-stat-dot { background: var(--green-go); }
    .stat-go { color: var(--green-go); background: rgba(34, 197, 94, 0.1); }
    .stat-caution .map-stat-dot { background: var(--amber-caution); }
    .stat-caution { color: var(--amber-caution); background: rgba(245, 158, 11, 0.1); }
    .stat-cancel .map-stat-dot { background: var(--red-cancel); }
    .stat-cancel { color: var(--red-cancel); background: rgba(239, 68, 68, 0.1); }
    .stat-pending .map-stat-dot { background: var(--text-secondary); }
    .stat-pending { color: var(--text-secondary); background: rgba(148, 163, 184, 0.1); }

    .map-filter-group {
        display: flex;
        gap: 0.4rem;
    }

    .map-filter-btn {
        padding: 0.3rem 0.7rem;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text-secondary);
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .map-filter-btn:hover { border-color: var(--teal); color: var(--white); }
    .map-filter-btn.active { background: var(--teal); border-color: var(--teal); color: var(--white); }

    /* --- Map Container --- */
    .map-container {
        flex: 1;
        position: relative;
    }

    #weather-map {
        width: 100%;
        height: 100%;
        background: var(--ocean-dark);
    }

    /* --- Time Slider Bar --- */
    .time-slider-bar {
        background: var(--ocean-mid);
        border-top: 1px solid var(--border);
        padding: 0.5rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        z-index: 500;
    }

    .time-display {
        min-width: 190px;
        text-align: center;
    }

    .time-display-date {
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .time-display-hour {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--white);
        font-variant-numeric: tabular-nums;
    }

    .time-display-label {
        font-size: 0.65rem;
        color: var(--text-secondary);
    }

    .time-slider-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .time-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text-secondary);
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        transition: all 0.15s;
    }

    .time-btn:hover { border-color: var(--teal); color: var(--white); }
    .time-btn.active { background: var(--teal); border-color: var(--teal); color: var(--white); }

    .time-slider-track {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .time-slider-input {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        background: var(--surface-light);
        border-radius: 3px;
        outline: none;
        cursor: pointer;
    }

    .time-slider-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--teal);
        border: 2px solid var(--white);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    .time-slider-input::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--teal);
        border: 2px solid var(--white);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    .time-ticks {
        display: flex;
        justify-content: space-between;
        padding: 0 2px;
    }

    .time-tick {
        font-size: 0.6rem;
        color: var(--text-secondary);
        font-variant-numeric: tabular-nums;
    }

    .heatmap-toggle {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.3rem 0.7rem;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text-secondary);
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        white-space: nowrap;
    }

    .heatmap-toggle:hover { border-color: var(--teal); color: var(--white); }
    .heatmap-toggle.active { background: rgba(14, 165, 233, 0.15); border-color: var(--teal); color: var(--teal); }

    /* --- Leaflet dark theme overrides --- */
    .leaflet-container { background: var(--ocean-dark); font-family: inherit; }
    .leaflet-container a { color: var(--teal-bright); }

    .leaflet-control-attribution {
        background: rgba(10, 22, 40, 0.85) !important;
        color: var(--text-secondary) !important;
        font-size: 0.65rem !important;
        padding: 2px 6px !important;
    }
    .leaflet-control-attribution a { color: var(--teal) !important; }

    .leaflet-control-zoom a {
        background: var(--surface) !important;
        color: var(--text-primary) !important;
        border-color: var(--border) !important;
    }
    .leaflet-control-zoom a:hover { background: var(--surface-light) !important; }

    .leaflet-control-layers {
        background: var(--surface) !important;
        border: 1px solid var(--border) !important;
        border-radius: var(--radius) !important;
        color: var(--text-primary) !important;
        box-shadow: var(--shadow) !important;
    }
    .leaflet-control-layers-toggle {
        background-color: var(--surface) !important;
        border: 1px solid var(--border) !important;
    }
    .leaflet-control-layers label { color: var(--text-primary); font-size: 0.85rem; }

    /* --- Custom Markers --- */
    .site-marker {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        border: 2px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), 0 0 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .site-marker:hover {
        transform: rotate(-45deg) scale(1.15);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 0, 0, 0.3);
    }

    .site-marker-inner {
        transform: rotate(45deg);
        font-size: 12px;
        font-weight: 700;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    }

    .marker-go { background: linear-gradient(135deg, #22c55e, #16a34a); border-color: rgba(255, 255, 255, 0.6); }
    .marker-caution { background: linear-gradient(135deg, #f59e0b, #d97706); border-color: rgba(255, 255, 255, 0.6); }
    .marker-cancel { background: linear-gradient(135deg, #ef4444, #dc2626); border-color: rgba(255, 255, 255, 0.6); animation: pulse-cancel 2s ease-in-out infinite; }
    .marker-pending { background: linear-gradient(135deg, #64748b, #475569); border-color: rgba(255, 255, 255, 0.4); }
    .marker-complete { background: linear-gradient(135deg, #334155, #1e293b); border-color: rgba(255, 255, 255, 0.2); opacity: 0.6; }

    @keyframes pulse-cancel {
        0%, 100% { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), 0 0 0 0 rgba(239, 68, 68, 0.4); }
        50% { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), 0 0 0 8px rgba(239, 68, 68, 0); }
    }

    /* --- Popups --- */
    .leaflet-popup-content-wrapper {
        background: var(--surface) !important;
        border: 1px solid var(--border) !important;
        border-radius: var(--radius) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5) !important;
        color: var(--text-primary) !important;
        padding: 0 !important;
    }
    .leaflet-popup-content { margin: 0 !important; min-width: 260px; }
    .leaflet-popup-tip { background: var(--surface) !important; border: 1px solid var(--border) !important; }
    .leaflet-popup-close-button { color: var(--text-secondary) !important; font-size: 20px !important; padding: 6px 8px !important; width: auto !important; height: auto !important; }
    .leaflet-popup-close-button:hover { color: var(--white) !important; }

    .popup-content { padding: 0; }
    .popup-header { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .popup-site-name { font-weight: 700; color: var(--white); font-size: 0.95rem; }
    .popup-client { font-size: 0.75rem; color: var(--text-secondary); }
    .popup-recommendation { padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .popup-rec-go { background: rgba(34, 197, 94, 0.15); color: var(--green-go); }
    .popup-rec-caution { background: rgba(245, 158, 11, 0.15); color: var(--amber-caution); }
    .popup-rec-cancel { background: rgba(239, 68, 68, 0.15); color: var(--red-cancel); }
    .popup-rec-pending { background: rgba(148, 163, 184, 0.15); color: var(--text-secondary); }

    .popup-body { padding: 0.8rem 1rem; }
    .popup-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1.2rem; margin-bottom: 0.8rem; }
    .popup-stat { display: flex; flex-direction: column; }
    .popup-stat-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); font-weight: 600; }
    .popup-stat-value { font-size: 1rem; font-weight: 700; color: var(--white); }
    .popup-meta { font-size: 0.7rem; color: var(--text-secondary); padding-top: 0.6rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .popup-link { display: inline-block; padding: 0.25rem 0.6rem; background: var(--teal); color: var(--white) !important; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-decoration: none !important; transition: background 0.15s; }
    .popup-link:hover { background: var(--teal-bright); }
    .popup-no-forecast { text-align: center; padding: 0.5rem 0; color: var(--text-secondary); font-size: 0.85rem; }

    /* --- Cluster overrides --- */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background: rgba(14, 165, 233, 0.25) !important; }
    .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div { background: var(--teal) !important; color: var(--white) !important; font-weight: 700 !important; font-size: 13px !important; }

    /* --- Risk grid legend --- */
    .risk-legend {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 0.6rem 0.8rem;
        box-shadow: var(--shadow);
    }
    .risk-legend h4 { margin: 0 0 0.4rem 0; font-size: 0.75rem; color: var(--white); }
    .risk-legend-row { display: flex; align-items: center; gap: 0.4rem; margin: 0.15rem 0; }
    .risk-legend-swatch { width: 20px; height: 12px; border-radius: 2px; }
    .risk-legend-label { font-size: 0.7rem; color: var(--text-secondary); }

    /* --- Loading overlay --- */
    .map-loading {
        position: absolute;
        inset: 0;
        background: rgba(10, 22, 40, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.4s;
    }
    .map-loading.loaded { opacity: 0; pointer-events: none; }
    .loading-spinner { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
    .spinner-ring { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--teal); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: var(--text-secondary); font-size: 0.85rem; }

    /* --- Responsive --- */
    @media (max-width: 768px) {
        .map-page { height: calc(100vh - 64px - 40px); }
        .map-controls { padding: 0.4rem 0.75rem; gap: 0.5rem; }
        .map-title h1 { font-size: 0.95rem; }
        .map-stats { gap: 0.5rem; }
        .map-stat { font-size: 0.7rem; padding: 0.2rem 0.4rem; }
        .map-filter-group { display: none; }
        .time-slider-bar { padding: 0.4rem 0.75rem; gap: 0.5rem; }
        .time-display { min-width: 130px; }
        .time-display-hour { font-size: 1.1rem; }
        .time-ticks { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="map-page">

    <!-- Controls Bar -->
    <div class="map-controls">
        <div class="map-title">
            <span class="map-icon">üó∫Ô∏è</span>
            <h1>Site Weather Map</h1>
        </div>

        <div class="map-stats" id="map-stats">
            {% if go_count %}
            <div class="map-stat stat-go"><span class="map-stat-dot"></span> <span id="stat-go">{{ go_count }}</span> GO</div>
            {% endif %}
            {% if caution_count %}
            <div class="map-stat stat-caution"><span class="map-stat-dot"></span> <span id="stat-caution">{{ caution_count }}</span> CAUTION</div>
            {% endif %}
            {% if cancel_count %}
            <div class="map-stat stat-cancel"><span class="map-stat-dot"></span> <span id="stat-cancel">{{ cancel_count }}</span> CANCEL</div>
            {% endif %}
            {% if pending_count %}
            <div class="map-stat stat-pending"><span class="map-stat-dot"></span> <span id="stat-pending">{{ pending_count }}</span> Pending</div>
            {% endif %}
        </div>

        <div class="map-filter-group">
            <button class="map-filter-btn active" data-filter="all">All</button>
            <button class="map-filter-btn" data-filter="GO">Go</button>
            <button class="map-filter-btn" data-filter="CAUTION">Caution</button>
            <button class="map-filter-btn" data-filter="CANCEL">Cancel</button>
        </div>
    </div>

    <!-- Map -->
    <div class="map-container">
        <div id="weather-map"></div>
        <div class="map-loading" id="map-loading">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <span class="loading-text">Loading site data‚Ä¶</span>
            </div>
        </div>
    </div>

    <!-- Time Slider Bar -->
    <div class="time-slider-bar">
        <div class="time-display">
            <div class="time-display-date" id="time-date">‚Äî</div>
            <div class="time-display-hour" id="time-hour">Latest</div>
            <div class="time-display-label" id="time-label">Summary view</div>
        </div>

        <div class="time-slider-controls">
            <button class="time-btn" id="btn-step-back" title="Previous hour">‚óÄ</button>
            <button class="time-btn" id="btn-play" title="Play animation">‚ñ∂</button>
            <button class="time-btn" id="btn-step-fwd" title="Next hour">‚ñ∂</button>
            <button class="time-btn" id="btn-live" title="Return to latest summary">‚ü≤</button>
        </div>

        <div class="time-slider-track">
            <input type="range" class="time-slider-input" id="time-slider" min="0" max="0" value="0" step="1" />
            <div class="time-ticks" id="time-ticks"></div>
        </div>

        <button class="heatmap-toggle" id="btn-heatmap" title="Toggle UK risk heatmap">
            üå°Ô∏è Risk Grid
        </button>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<!-- Leaflet MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(function () {
    'use strict';

    // ============================================================
    // CONFIG
    // ============================================================

    const UK_CENTER = [54.5, -2.5];
    const UK_ZOOM = 6;
    const SITES_URL = '{% url "dashboard:map_sites_json" %}';
    const SITES_HOURLY_URL = '{% url "dashboard:map_sites_hourly_json" %}';
    const RISK_GRID_URL = '{% url "dashboard:map_risk_grid_json" %}';

    const MARKER_CLASSES = { GO: 'marker-go', CAUTION: 'marker-caution', CANCEL: 'marker-cancel', PENDING: 'marker-pending' };
    const REC_POPUP_CLASSES = { GO: 'popup-rec-go', CAUTION: 'popup-rec-caution', CANCEL: 'popup-rec-cancel', PENDING: 'popup-rec-pending' };

    // Risk colour stops for the heatmap grid
    const RISK_COLOURS = [
        [0,   'rgba(34, 197, 94, 0.35)'],    // green ‚Äî low risk
        [20,  'rgba(34, 197, 94, 0.5)'],
        [35,  'rgba(245, 158, 11, 0.5)'],     // amber ‚Äî caution
        [50,  'rgba(245, 158, 11, 0.65)'],
        [65,  'rgba(239, 68, 68, 0.55)'],     // red ‚Äî cancel
        [80,  'rgba(239, 68, 68, 0.7)'],
        [100, 'rgba(185, 28, 28, 0.8)'],
    ];

    function riskToColour(risk) {
        for (let i = RISK_COLOURS.length - 1; i >= 0; i--) {
            if (risk >= RISK_COLOURS[i][0]) return RISK_COLOURS[i][1];
        }
        return RISK_COLOURS[0][1];
    }


    // ============================================================
    // MAP INITIALISATION
    // ============================================================

    const map = L.map('weather-map', {
        center: UK_CENTER,
        zoom: UK_ZOOM,
        zoomControl: true,
        attributionControl: true,
        maxBounds: [[-5, -30], [72, 40]],
        minZoom: 4,
        maxZoom: 18,
    });

    const darkTiles = L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>', subdomains: 'abcd', maxZoom: 20 }
    );

    const standardTiles = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>', maxZoom: 19 }
    );

    darkTiles.addTo(map);

    const baseLayers = { 'Dark': darkTiles, 'Standard': standardTiles };
    const overlayLayers = {};

    L.control.layers(baseLayers, overlayLayers, { position: 'topright' }).addTo(map);


    // ============================================================
    // RISK GRID LEGEND
    // ============================================================

    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'risk-legend');
        div.innerHTML = '<h4>Risk Level</h4>' +
            '<div class="risk-legend-row"><span class="risk-legend-swatch" style="background:rgba(34,197,94,0.6)"></span><span class="risk-legend-label">0‚Äì20% GO</span></div>' +
            '<div class="risk-legend-row"><span class="risk-legend-swatch" style="background:rgba(245,158,11,0.6)"></span><span class="risk-legend-label">20‚Äì50% CAUTION</span></div>' +
            '<div class="risk-legend-row"><span class="risk-legend-swatch" style="background:rgba(239,68,68,0.65)"></span><span class="risk-legend-label">50‚Äì100% CANCEL</span></div>';
        return div;
    };


    // ============================================================
    // MARKER HELPERS
    // ============================================================

    function createMarkerIcon(recommendation, complete) {
        const cls = complete ? 'marker-complete' : (MARKER_CLASSES[recommendation] || 'marker-pending');
        const label = complete ? '‚úì' : (recommendation === 'PENDING' ? '?' : recommendation.charAt(0));
        return L.divIcon({
            className: '',
            html: '<div class="site-marker ' + cls + '"><span class="site-marker-inner">' + label + '</span></div>',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28],
        });
    }

    function formatPopupSummary(props) {
        const rec = props.recommendation || 'PENDING';
        const recClass = REC_POPUP_CLASSES[rec] || 'popup-rec-pending';
        let statsHtml = '';

        if (props.has_forecast) {
            const risk = props.peak_risk !== null ? props.peak_risk + '%' : '‚Äî';
            const wind = props.peak_wind !== null ? props.peak_wind + ' m/s' : '‚Äî';
            const gust = props.peak_gust !== null ? props.peak_gust + ' m/s' : '‚Äî';
            const precip = props.peak_precip !== null ? props.peak_precip + ' mm/h' : '‚Äî';
            const temp = props.min_temp !== null ? props.min_temp + '¬∞C' : '‚Äî';
            let dateStr = '';
            if (props.forecast_date) {
                const d = new Date(props.forecast_date + 'T00:00:00');
                dateStr = d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
            }
            let genStr = '';
            if (props.generated_at) {
                const g = new Date(props.generated_at);
                genStr = g.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            }
            statsHtml = '<div class="popup-stats-grid">' +
                '<div class="popup-stat"><span class="popup-stat-label">Peak Risk</span><span class="popup-stat-value">' + risk + '</span></div>' +
                '<div class="popup-stat"><span class="popup-stat-label">Peak Wind</span><span class="popup-stat-value">' + wind + '</span></div>' +
                '<div class="popup-stat"><span class="popup-stat-label">Peak Gust</span><span class="popup-stat-value">' + gust + '</span></div>' +
                '<div class="popup-stat"><span class="popup-stat-label">Precipitation</span><span class="popup-stat-value">' + precip + '</span></div>' +
                '<div class="popup-stat"><span class="popup-stat-label">Min Temp</span><span class="popup-stat-value">' + temp + '</span></div>' +
                '<div class="popup-stat"><span class="popup-stat-label">Exposure</span><span class="popup-stat-value">' + props.exposure + '</span></div>' +
                '</div>' +
                '<div class="popup-meta"><span>' + dateStr + ' ¬∑ ' + genStr + ' UTC</span>' +
                '<a href="/dashboard/site/' + props.id + '/" class="popup-link">Full Forecast ‚Üí</a></div>';
        } else {
            statsHtml = '<div class="popup-no-forecast"><p>No forecast data yet</p>' +
                '<p style="font-size:0.75rem;margin-top:0.3rem;">' + props.exposure + ' ¬∑ ' + props.postcode + '</p></div>' +
                '<div class="popup-meta"><span>&nbsp;</span><a href="/dashboard/site/' + props.id + '/" class="popup-link">View Site ‚Üí</a></div>';
        }

        return '<div class="popup-content"><div class="popup-header"><div>' +
            '<div class="popup-site-name">' + props.name + '</div>' +
            '<div class="popup-client">' + props.client + ' ¬∑ ' + props.postcode + '</div></div>' +
            '<span class="popup-recommendation ' + recClass + '">' + rec + '</span></div>' +
            '<div class="popup-body">' + statsHtml + '</div></div>';
    }

    function formatPopupHourly(props, ts) {
        const rec = props.recommendation || 'PENDING';
        const recClass = REC_POPUP_CLASSES[rec] || 'popup-rec-pending';
        const d = new Date(ts);
        const timeStr = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) + ' UTC';
        const dateStr = d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });

        return '<div class="popup-content"><div class="popup-header"><div>' +
            '<div class="popup-site-name">' + props.name + '</div>' +
            '<div class="popup-client">' + props.client + ' ¬∑ ' + props.postcode + '</div></div>' +
            '<span class="popup-recommendation ' + recClass + '">' + rec + '</span></div>' +
            '<div class="popup-body"><div class="popup-stats-grid">' +
            '<div class="popup-stat"><span class="popup-stat-label">Risk</span><span class="popup-stat-value">' + props.risk + '%</span></div>' +
            '<div class="popup-stat"><span class="popup-stat-label">Wind</span><span class="popup-stat-value">' + props.wind_speed + ' m/s</span></div>' +
            '<div class="popup-stat"><span class="popup-stat-label">Gusts</span><span class="popup-stat-value">' + props.wind_gusts + ' m/s</span></div>' +
            '<div class="popup-stat"><span class="popup-stat-label">Precip</span><span class="popup-stat-value">' + props.precipitation + ' mm/h</span></div>' +
            '<div class="popup-stat"><span class="popup-stat-label">Temp</span><span class="popup-stat-value">' + props.temperature + '¬∞C</span></div>' +
            '<div class="popup-stat"><span class="popup-stat-label">Time</span><span class="popup-stat-value">' + timeStr + '</span></div>' +
            '</div><div class="popup-meta"><span>' + dateStr + '</span>' +
            '<a href="/dashboard/site/' + props.id + '/" class="popup-link">Full Forecast ‚Üí</a></div></div></div>';
    }


    // ============================================================
    // STATE
    // ============================================================

    const clusterGroup = L.markerClusterGroup({
        maxClusterRadius: 35, spiderfyOnMaxZoom: true,
        showCoverageOnHover: false, zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 10,
    });
    map.addLayer(clusterGroup);

    let summaryData = null;       // GeoJSON from sites.json (latest summary)
    let hourlyData = null;        // { timestamps: [], frames: {} } from sites-hourly.json
    let riskGridMeta = null;      // Grid metadata (timestamps, resolution)
    let riskGridLayer = L.layerGroup();  // Holds rectangle overlays
    let riskGridVisible = false;

    let currentMode = 'summary';  // 'summary' or 'hourly'
    let currentTimestampIdx = 0;
    let activeFilter = 'all';
    let playInterval = null;

    // DOM refs
    const slider = document.getElementById('time-slider');
    const timeDate = document.getElementById('time-date');
    const timeHour = document.getElementById('time-hour');
    const timeLabel = document.getElementById('time-label');
    const timeTicks = document.getElementById('time-ticks');
    const btnPlay = document.getElementById('btn-play');
    const btnLive = document.getElementById('btn-live');
    const btnStepBack = document.getElementById('btn-step-back');
    const btnStepFwd = document.getElementById('btn-step-fwd');
    const btnHeatmap = document.getElementById('btn-heatmap');


    // ============================================================
    // DATA LOADING
    // ============================================================

    function loadSummaryData() {
        return fetch(SITES_URL)
            .then(r => r.json())
            .then(geojson => { summaryData = geojson; });
    }

    function loadHourlyData() {
        return fetch(SITES_HOURLY_URL)
            .then(r => r.json())
            .then(data => { hourlyData = data; });
    }

    function loadRiskGridMeta() {
        return fetch(RISK_GRID_URL)
            .then(r => r.json())
            .then(data => { riskGridMeta = data; });
    }

    function loadRiskGridFrame(timestamp) {
        return fetch(RISK_GRID_URL + '?timestamp=' + encodeURIComponent(timestamp))
            .then(r => r.json());
    }


    // ============================================================
    // RENDERING ‚Äî SUMMARY MODE (latest snapshot)
    // ============================================================

    function renderSummary() {
        currentMode = 'summary';
        clusterGroup.clearLayers();

        if (!summaryData || !summaryData.features) return;

        summaryData.features.forEach(function (feature) {
            const coords = feature.geometry.coordinates;
            const props = feature.properties;
            if (activeFilter !== 'all' && props.recommendation !== activeFilter) return;

            const icon = createMarkerIcon(props.recommendation, props.job_complete);
            const marker = L.marker([coords[1], coords[0]], { icon: icon });
            marker.bindPopup(formatPopupSummary(props), { maxWidth: 320, minWidth: 260 });
            clusterGroup.addLayer(marker);
        });

        timeDate.textContent = '‚Äî';
        timeHour.textContent = 'Latest';
        timeLabel.textContent = 'Summary view';
    }


    // ============================================================
    // RENDERING ‚Äî HOURLY MODE (time slider active)
    // ============================================================

    function renderHourlyFrame(idx) {
        if (!hourlyData || !hourlyData.timestamps || !hourlyData.timestamps.length) return;

        currentMode = 'hourly';
        currentTimestampIdx = Math.max(0, Math.min(idx, hourlyData.timestamps.length - 1));
        const ts = hourlyData.timestamps[currentTimestampIdx];
        const frame = hourlyData.frames[ts];

        // Update time display
        const d = new Date(ts);
        timeDate.textContent = d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
        timeHour.textContent = d.toUTCHours().toString().padStart(2, '0') + ':' + d.toUTCMinutes().toString().padStart(2, '0') + ' UTC';
        timeLabel.textContent = 'Hour ' + (currentTimestampIdx + 1) + ' of ' + hourlyData.timestamps.length;

        slider.value = currentTimestampIdx;

        // Redraw markers
        clusterGroup.clearLayers();

        if (frame && frame.features) {
            frame.features.forEach(function (feature) {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;
                if (activeFilter !== 'all' && props.recommendation !== activeFilter) return;

                const icon = createMarkerIcon(props.recommendation, false);
                const marker = L.marker([coords[1], coords[0]], { icon: icon });
                marker.bindPopup(formatPopupHourly(props, ts), { maxWidth: 320, minWidth: 260 });
                clusterGroup.addLayer(marker);
            });
        }

        // If risk grid is visible, update that too
        if (riskGridVisible && riskGridMeta && riskGridMeta.available) {
            renderRiskGridAtTimestamp(ts);
        }
    }

    // Fix for toUTCHours/toUTCMinutes not being standard
    Date.prototype.toUTCHours = function () { return this.getUTCHours(); };
    Date.prototype.toUTCMinutes = function () { return this.getUTCMinutes(); };


    // ============================================================
    // RISK GRID HEATMAP RENDERING
    // ============================================================

    function renderRiskGridAtTimestamp(ts) {
        riskGridLayer.clearLayers();

        if (!riskGridMeta || !riskGridMeta.available) return;

        // Find the closest available grid timestamp
        const gridTimestamps = riskGridMeta.timestamps;
        let closestTs = gridTimestamps[0];
        let minDiff = Math.abs(new Date(ts) - new Date(closestTs));

        for (let i = 1; i < gridTimestamps.length; i++) {
            const diff = Math.abs(new Date(ts) - new Date(gridTimestamps[i]));
            if (diff < minDiff) {
                minDiff = diff;
                closestTs = gridTimestamps[i];
            }
        }

        loadRiskGridFrame(closestTs).then(function (geojson) {
            if (!geojson.features) return;

            const res = riskGridMeta.resolution || 0.5;
            const halfRes = res / 2;

            geojson.features.forEach(function (feature) {
                const coords = feature.geometry.coordinates;
                const risk = feature.properties.risk;
                const colour = riskToColour(risk);

                const bounds = [
                    [coords[1] - halfRes, coords[0] - halfRes],
                    [coords[1] + halfRes, coords[0] + halfRes],
                ];

                const rect = L.rectangle(bounds, {
                    color: 'transparent',
                    fillColor: colour,
                    fillOpacity: 1,
                    weight: 0,
                    interactive: false,
                });

                riskGridLayer.addLayer(rect);
            });
        });
    }


    // ============================================================
    // TIME SLIDER SETUP
    // ============================================================

    function setupTimeSlider() {
        if (!hourlyData || !hourlyData.timestamps || !hourlyData.timestamps.length) {
            slider.max = 0;
            slider.value = 0;
            return;
        }

        const ts = hourlyData.timestamps;
        slider.max = ts.length - 1;
        slider.value = 0;

        // Build tick marks (show every 6 hours)
        timeTicks.innerHTML = '';
        const step = Math.max(1, Math.floor(ts.length / 12));
        for (let i = 0; i < ts.length; i += step) {
            const d = new Date(ts[i]);
            const tick = document.createElement('span');
            tick.className = 'time-tick';
            tick.textContent = d.getUTCHours().toString().padStart(2, '0') + ':00';
            timeTicks.appendChild(tick);
        }
    }


    // ============================================================
    // CONTROLS
    // ============================================================

    slider.addEventListener('input', function () {
        if (currentMode === 'summary' && hourlyData && hourlyData.timestamps.length) {
            // Switching from summary to hourly
            currentMode = 'hourly';
        }
        renderHourlyFrame(parseInt(this.value, 10));
    });

    btnStepBack.addEventListener('click', function () {
        if (currentMode === 'summary') {
            if (hourlyData && hourlyData.timestamps.length) renderHourlyFrame(0);
            return;
        }
        renderHourlyFrame(currentTimestampIdx - 1);
    });

    btnStepFwd.addEventListener('click', function () {
        if (currentMode === 'summary') {
            if (hourlyData && hourlyData.timestamps.length) renderHourlyFrame(0);
            return;
        }
        renderHourlyFrame(currentTimestampIdx + 1);
    });

    btnLive.addEventListener('click', function () {
        stopPlayback();
        renderSummary();
        slider.value = 0;
    });

    btnPlay.addEventListener('click', function () {
        if (playInterval) {
            stopPlayback();
        } else {
            startPlayback();
        }
    });

    function startPlayback() {
        if (!hourlyData || !hourlyData.timestamps.length) return;

        if (currentMode === 'summary') {
            renderHourlyFrame(0);
        }

        btnPlay.textContent = '‚è∏';
        btnPlay.classList.add('active');

        playInterval = setInterval(function () {
            const next = currentTimestampIdx + 1;
            if (next >= hourlyData.timestamps.length) {
                stopPlayback();
                return;
            }
            renderHourlyFrame(next);
        }, 600);
    }

    function stopPlayback() {
        if (playInterval) {
            clearInterval(playInterval);
            playInterval = null;
        }
        btnPlay.textContent = '‚ñ∂';
        btnPlay.classList.remove('active');
    }

    // Filter buttons
    document.querySelectorAll('.map-filter-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            document.querySelectorAll('.map-filter-btn').forEach(function (b) { b.classList.remove('active'); });
            this.classList.add('active');
            activeFilter = this.dataset.filter;
            if (currentMode === 'summary') {
                renderSummary();
            } else {
                renderHourlyFrame(currentTimestampIdx);
            }
        });
    });

    // Heatmap toggle
    btnHeatmap.addEventListener('click', function () {
        riskGridVisible = !riskGridVisible;
        this.classList.toggle('active', riskGridVisible);

        if (riskGridVisible) {
            map.addLayer(riskGridLayer);
            legend.addTo(map);

            if (riskGridMeta && riskGridMeta.available) {
                // Pick the right timestamp
                let ts;
                if (currentMode === 'hourly' && hourlyData && hourlyData.timestamps.length) {
                    ts = hourlyData.timestamps[currentTimestampIdx];
                } else if (riskGridMeta.timestamps && riskGridMeta.timestamps.length) {
                    // Default to first available
                    ts = riskGridMeta.timestamps[0];
                }
                if (ts) renderRiskGridAtTimestamp(ts);
            }
        } else {
            map.removeLayer(riskGridLayer);
            legend.remove();
            riskGridLayer.clearLayers();
        }
    });


    // ============================================================
    // BOOT ‚Äî Load everything in parallel
    // ============================================================

    Promise.all([
        loadSummaryData(),
        loadHourlyData(),
        loadRiskGridMeta(),
    ]).then(function () {
        // Render summary view first
        renderSummary();
        setupTimeSlider();

        // Auto-fit bounds
        if (summaryData && summaryData.features && summaryData.features.length) {
            const lats = summaryData.features.map(function (f) { return f.geometry.coordinates[1]; });
            const lons = summaryData.features.map(function (f) { return f.geometry.coordinates[0]; });
            const bounds = [
                [Math.min.apply(null, lats) - 0.5, Math.min.apply(null, lons) - 0.5],
                [Math.max.apply(null, lats) + 0.5, Math.max.apply(null, lons) + 0.5],
            ];
            map.fitBounds(bounds, { maxZoom: 12 });
        }

        // Remove loading overlay
        document.getElementById('map-loading').classList.add('loaded');

        // Show risk grid availability in console
        if (riskGridMeta && riskGridMeta.available) {
            console.log('Risk grid available: ' + riskGridMeta.grid_points + ' points, ' + riskGridMeta.timestamps.length + ' hours');
        } else {
            console.log('No risk grid data ‚Äî run: python manage.py generate_risk_grid');
        }
    }).catch(function (err) {
        console.error('Failed to load map data:', err);
        document.getElementById('map-loading').innerHTML =
            '<div class="loading-spinner"><span class="loading-text" style="color: var(--red-cancel);">Failed to load site data</span></div>';
    });

    // Auto-refresh every 5 minutes (summary data only ‚Äî hourly stays until slider moves)
    setInterval(function () {
        loadSummaryData().then(function () {
            if (currentMode === 'summary') renderSummary();
        });
    }, 5 * 60 * 1000);

})();
</script>
{% endblock %}
