{% extends "orcamet_portal/base.html" %}
{% load static %}

{% block title %}Weather Map ‚Äî OrcaMet Portal{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
/* Force full-width for map page */
.main-content { max-width: 100% !important; padding: 0 !important; }
.footer { display: none; }

.map-app { display: flex; flex-direction: column; height: calc(100vh - 64px); }

/* --- Variable bar --- */
.var-bar {
    background: var(--ocean-mid); border-bottom: 1px solid var(--border);
    padding: 0.5rem 1rem; display: flex; align-items: center; justify-content: space-between;
    gap: 0.75rem; flex-wrap: wrap; z-index: 500;
}
.var-bar-left { display: flex; align-items: center; gap: 1rem; }
.var-bar-title { font-weight: 700; color: #fff; font-size: 1rem; }
.var-pills { display: flex; gap: 3px; background: var(--ocean-dark); border-radius: 6px; padding: 3px; }
.var-pill {
    padding: 0.3rem 0.7rem; border: none; background: transparent;
    color: var(--text-secondary); font-size: 0.75rem; font-weight: 600;
    border-radius: 4px; cursor: pointer; transition: all 0.15s;
    font-family: inherit;
}
.var-pill:hover { color: var(--text-primary); }
.var-pill.active { background: var(--teal); color: #fff; }

.var-bar-right { display: flex; align-items: center; gap: 0.75rem; }
.site-counts { display: flex; gap: 0.5rem; }
.sc { font-size: 0.72rem; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 4px; display: flex; align-items: center; gap: 0.25rem; }
.sc-dot { width: 7px; height: 7px; border-radius: 50%; }
.sc-go { color: var(--green-go); background: rgba(34,197,94,0.1); }
.sc-go .sc-dot { background: var(--green-go); }
.sc-ca { color: var(--amber-caution); background: rgba(245,158,11,0.1); }
.sc-ca .sc-dot { background: var(--amber-caution); }
.sc-cx { color: var(--red-cancel); background: rgba(239,68,68,0.1); }
.sc-cx .sc-dot { background: var(--red-cancel); }

/* --- Map --- */
.map-wrap { flex: 1; position: relative; }
#wmap { width: 100%; height: 100%; background: var(--ocean-dark); }

/* --- Time bar --- */
.time-bar {
    background: var(--ocean-mid); border-top: 1px solid var(--border);
    padding: 0.45rem 1rem; display: flex; align-items: center; gap: 0.75rem; z-index: 500;
}
.tb-time { min-width: 140px; text-align: center; }
.tb-date { font-size: 0.6rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.6px; }
.tb-hour { font-size: 1.2rem; font-weight: 700; color: #fff; font-variant-numeric: tabular-nums; }
.tb-sub { font-size: 0.6rem; color: var(--text-secondary); }
.tb-btns { display: flex; gap: 3px; }
.tb-btn {
    width: 28px; height: 28px; border: 1px solid var(--border); background: var(--surface);
    color: var(--text-secondary); border-radius: 4px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 0.75rem;
    transition: all 0.12s; font-family: inherit;
}
.tb-btn:hover { border-color: var(--teal); color: #fff; }
.tb-btn.on { background: var(--teal); border-color: var(--teal); color: #fff; }
.tb-slider { flex: 1; }
.tb-range {
    -webkit-appearance: none; appearance: none; width: 100%; height: 4px;
    background: var(--surface-light); border-radius: 2px; outline: none; cursor: pointer;
}
.tb-range::-webkit-slider-thumb {
    -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%;
    background: var(--teal); border: 2px solid #fff; cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.4);
}
.tb-range::-moz-range-thumb {
    width: 16px; height: 16px; border-radius: 50%;
    background: var(--teal); border: 2px solid #fff; cursor: pointer;
}

/* --- Legend overlay --- */
.map-legend {
    position: absolute; bottom: 12px; right: 12px; z-index: 450;
    background: rgba(19,31,53,0.92); border: 1px solid var(--border);
    border-radius: 6px; padding: 0.55rem 0.65rem; backdrop-filter: blur(6px);
    min-width: 100px;
}
.ml-title { font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.7px; margin-bottom: 0.35rem; }
.ml-row { display: flex; align-items: center; gap: 0.35rem; margin: 0.1rem 0; }
.ml-swatch { width: 16px; height: 9px; border-radius: 2px; }
.ml-label { font-size: 0.62rem; color: var(--text-secondary); }

/* --- Loading --- */
.map-load { position: absolute; inset: 0; background: rgba(10,22,40,0.88); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.4s; }
.map-load.done { opacity: 0; pointer-events: none; }
.ml-spin { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--teal); border-radius: 50%; animation: sp 0.7s linear infinite; }
@keyframes sp { to { transform: rotate(360deg); } }
.ml-txt { color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.6rem; }

/* --- Leaflet dark --- */
.leaflet-container { background: var(--ocean-dark); font-family: inherit; }
.leaflet-control-attribution { background: rgba(10,22,40,0.8) !important; color: var(--text-secondary) !important; font-size: 0.6rem !important; }
.leaflet-control-attribution a { color: var(--teal) !important; }
.leaflet-control-zoom a { background: var(--surface) !important; color: var(--text-primary) !important; border-color: var(--border) !important; }

/* --- Markers --- */
.sm { display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 2px 6px rgba(0,0,0,0.4); transition: all 0.25s; }
.sm:hover { transform: rotate(-45deg) scale(1.15); }
.sm-i { transform: rotate(45deg); font-size: 11px; font-weight: 700; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
.sm-go { background: linear-gradient(135deg,#22c55e,#16a34a); }
.sm-ca { background: linear-gradient(135deg,#f59e0b,#d97706); }
.sm-cx { background: linear-gradient(135deg,#ef4444,#dc2626); animation: pcx 2s ease-in-out infinite; }
.sm-pn { background: linear-gradient(135deg,#64748b,#475569); border-color: rgba(255,255,255,0.3); }
@keyframes pcx { 0%,100% { box-shadow: 0 2px 6px rgba(0,0,0,0.4), 0 0 0 0 rgba(239,68,68,0.4); } 50% { box-shadow: 0 2px 6px rgba(0,0,0,0.4), 0 0 0 6px rgba(239,68,68,0); } }

/* --- Popups --- */
.leaflet-popup-content-wrapper { background: var(--surface) !important; border: 1px solid var(--border) !important; border-radius: 8px !important; box-shadow: 0 8px 24px rgba(0,0,0,0.5) !important; color: var(--text-primary) !important; padding: 0 !important; }
.leaflet-popup-content { margin: 0 !important; min-width: 240px; }
.leaflet-popup-tip { background: var(--surface) !important; border: 1px solid var(--border) !important; }
.leaflet-popup-close-button { color: var(--text-secondary) !important; font-size: 18px !important; padding: 4px 6px !important; }

.pp { padding: 0; }
.pp-hd { padding: 0.65rem 0.85rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.pp-name { font-weight: 700; color: #fff; font-size: 0.9rem; }
.pp-sub { font-size: 0.7rem; color: var(--text-secondary); }
.pp-badge { padding: 0.12rem 0.45rem; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; }
.pp-go { background: rgba(34,197,94,0.15); color: var(--green-go); }
.pp-ca { background: rgba(245,158,11,0.15); color: var(--amber-caution); }
.pp-cx { background: rgba(239,68,68,0.15); color: var(--red-cancel); }
.pp-pn { background: rgba(148,163,184,0.15); color: var(--text-secondary); }
.pp-bd { padding: 0.65rem 0.85rem; }
.pp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem 1rem; }
.pp-sl { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.4px; color: var(--text-secondary); font-weight: 600; }
.pp-sv { font-size: 0.9rem; font-weight: 700; color: #fff; }
.pp-ft { font-size: 0.65rem; color: var(--text-secondary); padding-top: 0.5rem; margin-top: 0.5rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.pp-link { display: inline-block; padding: 0.2rem 0.5rem; background: var(--teal); color: #fff !important; border-radius: 4px; font-size: 0.65rem; font-weight: 600; text-decoration: none !important; }

/* Cluster */
.marker-cluster-small,.marker-cluster-medium,.marker-cluster-large { background: rgba(14,165,233,0.2) !important; }
.marker-cluster-small div,.marker-cluster-medium div,.marker-cluster-large div { background: var(--teal) !important; color: #fff !important; font-weight: 700 !important; }

@media (max-width: 768px) {
    .var-bar { padding: 0.35rem 0.6rem; }
    .var-bar-title { display: none; }
    .site-counts { display: none; }
    .time-bar { padding: 0.35rem 0.6rem; gap: 0.5rem; }
    .tb-time { min-width: 100px; }
    .tb-hour { font-size: 1rem; }
}
</style>
{% endblock %}

{% block content %}
<div class="map-app">

    <div class="var-bar">
        <div class="var-bar-left">
            <span class="var-bar-title">üó∫Ô∏è Weather Map</span>
            <div class="var-pills" id="vpills">
                <button class="var-pill active" data-v="risk">Risk</button>
                <button class="var-pill" data-v="wind">Wind</button>
                <button class="var-pill" data-v="gust">Gusts</button>
                <button class="var-pill" data-v="precip">Precip</button>
                <button class="var-pill" data-v="temp">Temp</button>
            </div>
        </div>
        <div class="var-bar-right">
            <div class="site-counts" id="scounts">
                {% if go_count %}<span class="sc sc-go"><span class="sc-dot"></span>{{ go_count }} GO</span>{% endif %}
                {% if caution_count %}<span class="sc sc-ca"><span class="sc-dot"></span>{{ caution_count }} CAUTION</span>{% endif %}
                {% if cancel_count %}<span class="sc sc-cx"><span class="sc-dot"></span>{{ cancel_count }} CANCEL</span>{% endif %}
            </div>
        </div>
    </div>

    <div class="map-wrap">
        <div id="wmap"></div>
        <div class="map-legend" id="legend"></div>
        <div class="map-load" id="mload">
            <div style="text-align:center">
                <div class="ml-spin"></div>
                <div class="ml-txt">Loading forecast data‚Ä¶</div>
            </div>
        </div>
    </div>

    <div class="time-bar">
        <div class="tb-time">
            <div class="tb-date" id="tdate">‚Äî</div>
            <div class="tb-hour" id="thour">Latest</div>
            <div class="tb-sub" id="tsub">Peak summary</div>
        </div>
        <div class="tb-btns">
            <button class="tb-btn" id="bback">‚óÄ</button>
            <button class="tb-btn" id="bplay">‚ñ∂</button>
            <button class="tb-btn" id="bfwd">‚ñ∂</button>
            <button class="tb-btn" id="blive" title="Back to summary">‚ü≤</button>
        </div>
        <div class="tb-slider">
            <input type="range" class="tb-range" id="tslider" min="0" max="0" value="0" step="1">
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
(function(){
'use strict';

// ================================================================
// URLS
// ================================================================
var SUMMARY_URL = '{% url "dashboard:map_sites_json" %}';
var HOURLY_URL  = '{% url "dashboard:map_sites_hourly_json" %}';

// ================================================================
// RISK CALC ‚Äî mirrors core.py exactly
// ================================================================
function ramp(v, soft, hard, highBad) {
    if (highBad) { if (v<=soft) return 0; if (v>=hard) return 1; return (v-soft)/(hard-soft); }
    else         { if (v>=soft) return 0; if (v<=hard) return 1; return (soft-v)/(soft-hard); }
}
function sigmoid(x) { return 1/(1+Math.exp(-x)); }
function calcRisk(w,g,p,t) {
    var r = 0.30*ramp(w,10,14,true) + 0.40*ramp(g,15,20,true) + 0.20*ramp(p,0.7,2,true) + 0.10*ramp(t,1,-2,false);
    return Math.min(100, Math.max(0, sigmoid(6*(r-0.45))*100));
}
function recFromRisk(r) { return r<20?'GO':r<50?'CAUTION':'CANCEL'; }

// ================================================================
// COLOUR SCALES
// ================================================================
var SCALES = {
    risk:   { title:'Risk %',     unit:'%',    stops:[[0,[34,197,94],'0'],[20,[34,197,94],'20'],[35,[245,158,11],'35'],[50,[245,158,11],'50'],[70,[239,68,68],'70'],[100,[185,28,28],'100']] },
    wind:   { title:'Wind m/s',   unit:' m/s', stops:[[0,[59,130,246],'0'],[5,[34,197,94],'5'],[10,[245,158,11],'10'],[15,[239,68,68],'15'],[25,[185,28,28],'25+']] },
    gust:   { title:'Gusts m/s',  unit:' m/s', stops:[[0,[59,130,246],'0'],[8,[34,197,94],'8'],[15,[245,158,11],'15'],[20,[239,68,68],'20'],[35,[185,28,28],'35+']] },
    precip: { title:'Precip mm/h',unit:' mm',  stops:[[0,[100,116,139],'0'],[0.2,[96,165,250],'0.2'],[1,[59,130,246],'1'],[3,[37,99,235],'3'],[8,[29,78,216],'8+']] },
    temp:   { title:'Temp ¬∞C',    unit:'¬∞C',   stops:[[-5,[96,165,250],'-5'],[0,[147,197,253],'0'],[5,[254,240,138],'5'],[15,[251,191,36],'15'],[25,[239,68,68],'25+']] }
};

function lerp(a,b,t) { return [Math.round(a[0]+t*(b[0]-a[0])), Math.round(a[1]+t*(b[1]-a[1])), Math.round(a[2]+t*(b[2]-a[2]))]; }
function valToRgb(val, key) {
    var s = SCALES[key].stops;
    if (val<=s[0][0]) return s[0][1];
    if (val>=s[s.length-1][0]) return s[s.length-1][1];
    for (var i=0;i<s.length-1;i++) {
        if (val>=s[i][0] && val<=s[i+1][0]) {
            var t=(val-s[i][0])/(s[i+1][0]-s[i][0]);
            return lerp(s[i][1],s[i+1][1],t);
        }
    }
    return s[s.length-1][1];
}
function rgb(c,a) { return 'rgba('+c[0]+','+c[1]+','+c[2]+','+(a||1)+')'; }

// ================================================================
// MAP
// ================================================================
var map = L.map('wmap', { center:[54.5,-2.5], zoom:6, maxBounds:[[47,-15],[62,8]], minZoom:5, maxZoom:14 });
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution:'&copy; OSM &copy; CARTO', subdomains:'abcd', maxZoom:20
}).addTo(map);

var markers = L.markerClusterGroup({ maxClusterRadius:30, disableClusteringAtZoom:9, showCoverageOnHover:false, zoomToBoundsOnClick:true });
map.addLayer(markers);

// ================================================================
// STATE
// ================================================================
var summaryGJ = null;   // GeoJSON from sites.json
var hourlyD = null;     // {timestamps:[], frames:{}}
var mode = 'summary';   // 'summary' | 'hourly'
var curIdx = 0;
var curVar = 'risk';
var playTmr = null;

var $slider = document.getElementById('tslider');
var $tdate  = document.getElementById('tdate');
var $thour  = document.getElementById('thour');
var $tsub   = document.getElementById('tsub');

// ================================================================
// MARKER FACTORY
// ================================================================
function mkIcon(rec) {
    var cls = rec==='GO'?'sm-go':rec==='CAUTION'?'sm-ca':rec==='CANCEL'?'sm-cx':'sm-pn';
    var lbl = rec==='PENDING'?'?':rec.charAt(0);
    return L.divIcon({ className:'', iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-24],
        html:'<div class="sm '+cls+'"><span class="sm-i">'+lbl+'</span></div>' });
}

function fv(v,u) { return v!=null?v+u:'‚Äî'; }

function summaryPopup(p) {
    var rec=p.recommendation||'PENDING';
    var bc=rec==='GO'?'pp-go':rec==='CAUTION'?'pp-ca':rec==='CANCEL'?'pp-cx':'pp-pn';
    var body='';
    if (p.has_forecast) {
        body='<div class="pp-grid">'+
            '<div><span class="pp-sl">Peak Risk</span><div class="pp-sv">'+fv(p.peak_risk,'%')+'</div></div>'+
            '<div><span class="pp-sl">Peak Wind</span><div class="pp-sv">'+fv(p.peak_wind,' m/s')+'</div></div>'+
            '<div><span class="pp-sl">Peak Gust</span><div class="pp-sv">'+fv(p.peak_gust,' m/s')+'</div></div>'+
            '<div><span class="pp-sl">Precipitation</span><div class="pp-sv">'+fv(p.peak_precip,' mm/h')+'</div></div>'+
            '<div><span class="pp-sl">Min Temp</span><div class="pp-sv">'+fv(p.min_temp,'¬∞C')+'</div></div>'+
            '<div><span class="pp-sl">Exposure</span><div class="pp-sv">'+(p.exposure||'‚Äî')+'</div></div>'+
            '</div>';
        var dt='';
        if(p.forecast_date){var d=new Date(p.forecast_date+'T00:00:00');dt=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});}
        body+='<div class="pp-ft"><span>'+dt+'</span><a href="/dashboard/site/'+p.id+'/" class="pp-link">Full Forecast ‚Üí</a></div>';
    } else {
        body='<div style="text-align:center;padding:0.5rem 0;color:var(--text-secondary)">No forecast data yet</div>'+
             '<div class="pp-ft"><span>&nbsp;</span><a href="/dashboard/site/'+p.id+'/" class="pp-link">View Site ‚Üí</a></div>';
    }
    return '<div class="pp"><div class="pp-hd"><div><div class="pp-name">'+p.name+'</div><div class="pp-sub">'+p.client+' ¬∑ '+p.postcode+'</div></div>'+
           '<span class="pp-badge '+bc+'">'+rec+'</span></div><div class="pp-bd">'+body+'</div></div>';
}

function hourlyPopup(p, ts) {
    var rec=p.recommendation||'PENDING';
    var bc=rec==='GO'?'pp-go':rec==='CAUTION'?'pp-ca':rec==='CANCEL'?'pp-cx':'pp-pn';
    var d=new Date(ts);
    var tm=d.getUTCHours().toString().padStart(2,'0')+':'+d.getUTCMinutes().toString().padStart(2,'0')+' UTC';
    var dt=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
    // Calculate risk client-side from the hourly values
    var risk=calcRisk(p.wind_speed,p.wind_gusts,p.precipitation,p.temperature);
    return '<div class="pp"><div class="pp-hd"><div><div class="pp-name">'+p.name+'</div><div class="pp-sub">'+p.client+' ¬∑ '+p.postcode+'</div></div>'+
           '<span class="pp-badge '+bc+'">'+rec+'</span></div><div class="pp-bd"><div class="pp-grid">'+
           '<div><span class="pp-sl">Risk</span><div class="pp-sv">'+risk.toFixed(0)+'%</div></div>'+
           '<div><span class="pp-sl">Wind</span><div class="pp-sv">'+p.wind_speed+' m/s</div></div>'+
           '<div><span class="pp-sl">Gusts</span><div class="pp-sv">'+p.wind_gusts+' m/s</div></div>'+
           '<div><span class="pp-sl">Precip</span><div class="pp-sv">'+p.precipitation+' mm</div></div>'+
           '<div><span class="pp-sl">Temp</span><div class="pp-sv">'+p.temperature+'¬∞C</div></div>'+
           '<div><span class="pp-sl">Time</span><div class="pp-sv">'+tm+'</div></div>'+
           '</div><div class="pp-ft"><span>'+dt+'</span><a href="/dashboard/site/'+p.id+'/" class="pp-link">Full Forecast ‚Üí</a></div></div></div>';
}

// ================================================================
// GET VALUE FOR CURRENT VARIABLE
// ================================================================
function getVal(p, isHourly) {
    if (curVar==='risk') {
        if (isHourly) return calcRisk(p.wind_speed, p.wind_gusts, p.precipitation, p.temperature);
        return p.peak_risk||0;
    }
    if (curVar==='wind')   return isHourly ? p.wind_speed : (p.peak_wind||0);
    if (curVar==='gust')   return isHourly ? p.wind_gusts : (p.peak_gust||0);
    if (curVar==='precip') return isHourly ? p.precipitation : (p.peak_precip||0);
    if (curVar==='temp')   return isHourly ? p.temperature : (p.min_temp||10);
    return 0;
}

// ================================================================
// RENDER ‚Äî SUMMARY
// ================================================================
function renderSummary() {
    mode='summary';
    markers.clearLayers();
    if (!summaryGJ||!summaryGJ.features) return;
    summaryGJ.features.forEach(function(f){
        var c=f.geometry.coordinates, p=f.properties;
        var rec=p.recommendation||'PENDING';
        var m=L.marker([c[1],c[0]],{icon:mkIcon(rec)});
        m.bindPopup(summaryPopup(p),{maxWidth:300,minWidth:240});

        // Add a circle showing the selected variable's value
        var val=getVal(p,false);
        var clr=valToRgb(val,curVar);
        L.circleMarker([c[1],c[0]],{radius:getRadius(val),color:'transparent',fillColor:rgb(clr,0.5),fillOpacity:1,interactive:false}).addTo(markers);
        markers.addLayer(m);
    });
    $tdate.textContent='‚Äî'; $thour.textContent='Latest'; $tsub.textContent='Peak summary';
}

function getRadius(val) {
    // Scale radius by variable
    if (curVar==='risk') return 8+val*0.22;
    if (curVar==='wind'||curVar==='gust') return 8+val*0.8;
    if (curVar==='precip') return 8+val*4;
    if (curVar==='temp') return 14;
    return 12;
}

// ================================================================
// RENDER ‚Äî HOURLY FRAME
// ================================================================
function renderHourly(idx) {
    if (!hourlyD||!hourlyD.timestamps||!hourlyD.timestamps.length) return;
    mode='hourly';
    curIdx=Math.max(0,Math.min(idx,hourlyD.timestamps.length-1));
    var ts=hourlyD.timestamps[curIdx];
    var frame=hourlyD.frames[ts];
    var d=new Date(ts);

    $tdate.textContent=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
    $thour.textContent=d.getUTCHours().toString().padStart(2,'0')+':'+d.getUTCMinutes().toString().padStart(2,'0')+' UTC';
    $tsub.textContent='Hour '+(curIdx+1)+' of '+hourlyD.timestamps.length;
    $slider.value=curIdx;

    markers.clearLayers();
    if (!frame||!frame.features) return;
    frame.features.forEach(function(f){
        var c=f.geometry.coordinates, p=f.properties;
        var rec=p.recommendation||'PENDING';
        // Recalculate risk client-side for the variable colour
        var risk=calcRisk(p.wind_speed,p.wind_gusts,p.precipitation,p.temperature);
        // Override recommendation with client-side risk calc
        rec=recFromRisk(risk);

        var m=L.marker([c[1],c[0]],{icon:mkIcon(rec)});
        m.bindPopup(hourlyPopup(p,ts),{maxWidth:300,minWidth:240});

        var val=getVal(p,true);
        var clr=valToRgb(val,curVar);
        L.circleMarker([c[1],c[0]],{radius:getRadius(val),color:'transparent',fillColor:rgb(clr,0.5),fillOpacity:1,interactive:false}).addTo(markers);
        markers.addLayer(m);
    });
}

// ================================================================
// LEGEND
// ================================================================
function renderLegend() {
    var s=SCALES[curVar];
    var h='<div class="ml-title">'+s.title+'</div>';
    s.stops.forEach(function(st){ h+='<div class="ml-row"><span class="ml-swatch" style="background:'+rgb(st[1],0.7)+'"></span><span class="ml-label">'+st[2]+'</span></div>'; });
    document.getElementById('legend').innerHTML=h;
}

// ================================================================
// TIME SLIDER SETUP
// ================================================================
function setupSlider() {
    if (!hourlyD||!hourlyD.timestamps||!hourlyD.timestamps.length) { $slider.max=0; return; }
    $slider.max=hourlyD.timestamps.length-1; $slider.value=0;
}

// ================================================================
// CONTROLS
// ================================================================
$slider.addEventListener('input',function(){
    if (mode==='summary'&&hourlyD&&hourlyD.timestamps&&hourlyD.timestamps.length) mode='hourly';
    renderHourly(parseInt(this.value));
});

document.getElementById('bback').addEventListener('click',function(){
    if(mode==='summary'){if(hourlyD&&hourlyD.timestamps&&hourlyD.timestamps.length)renderHourly(0);return;}
    renderHourly(curIdx-1);
});
document.getElementById('bfwd').addEventListener('click',function(){
    if(mode==='summary'){if(hourlyD&&hourlyD.timestamps&&hourlyD.timestamps.length)renderHourly(0);return;}
    renderHourly(curIdx+1);
});
document.getElementById('blive').addEventListener('click',function(){ stopPlay(); renderSummary(); $slider.value=0; });
document.getElementById('bplay').addEventListener('click',function(){ playTmr?stopPlay():startPlay(); });

function startPlay(){
    if(!hourlyD||!hourlyD.timestamps||!hourlyD.timestamps.length)return;
    if(mode==='summary')renderHourly(0);
    var b=document.getElementById('bplay'); b.textContent='‚è∏'; b.classList.add('on');
    playTmr=setInterval(function(){
        var n=curIdx+1;
        if(n>=hourlyD.timestamps.length){stopPlay();return;}
        renderHourly(n);
    },500);
}
function stopPlay(){
    if(playTmr){clearInterval(playTmr);playTmr=null;}
    var b=document.getElementById('bplay'); b.textContent='‚ñ∂'; b.classList.remove('on');
}

// Variable pills
document.querySelectorAll('.var-pill').forEach(function(btn){
    btn.addEventListener('click',function(){
        document.querySelectorAll('.var-pill').forEach(function(b){b.classList.remove('active');});
        this.classList.add('active');
        curVar=this.dataset.v;
        renderLegend();
        if(mode==='summary')renderSummary(); else renderHourly(curIdx);
    });
});

// ================================================================
// DATA LOADING ‚Äî independent, non-blocking
// ================================================================
function loadSummary(){
    return fetch(SUMMARY_URL).then(function(r){return r.json();}).then(function(d){summaryGJ=d;}).catch(function(e){console.warn('Sites:',e);});
}
function loadHourly(){
    return fetch(HOURLY_URL).then(function(r){return r.json();}).then(function(d){hourlyD=d;}).catch(function(e){console.warn('Hourly:',e);});
}

// ================================================================
// BOOT
// ================================================================
renderLegend();

var p1=loadSummary();
var p2=loadHourly();

p1.then(function(){
    renderSummary();
    if(summaryGJ&&summaryGJ.features&&summaryGJ.features.length){
        var lats=summaryGJ.features.map(function(f){return f.geometry.coordinates[1];});
        var lons=summaryGJ.features.map(function(f){return f.geometry.coordinates[0];});
        map.fitBounds([[Math.min.apply(null,lats)-0.5,Math.min.apply(null,lons)-0.5],[Math.max.apply(null,lats)+0.5,Math.max.apply(null,lons)+0.5]],{maxZoom:10});
    }
    document.getElementById('mload').classList.add('done');
});

p2.then(function(){ setupSlider(); });

// Auto-refresh summary every 5 mins
setInterval(function(){ loadSummary().then(function(){ if(mode==='summary')renderSummary(); }); },300000);

})();
</script>
{% endblock %}
